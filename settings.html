<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update, push, onValue, remove, set, get, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC7omObD0cWgdqGsNq-8L7n9i_Akp_JCEM",
        authDomain: "master-web-app-d8d1b.firebaseapp.com",
        projectId: "master-web-app-d8d1b",
        databaseURL: "https://master-web-app-d8d1b-default-rtdb.firebaseio.com",
        appId: "1:460731698074:web:40ad4f12c5fb3126874823"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 1. CHECK IF ALREADY LOGGED IN ON LOAD
    window.onload = () => {
        if(localStorage.getItem("fleet_admin_logged_in") === "true") {
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('admin-content').classList.remove('hidden');
            window.loadData();
        }
    };

    const selector = document.getElementById('taxi-selector');
    for(let i=1; i<=20; i++) {
        let opt = document.createElement('option'); opt.value = 'taxi' + i; opt.innerHTML = 'MANAGE TAXI ' + i;
        selector.appendChild(opt);
    }

    window.checkPass = () => {
        if(document.getElementById('pass-input').value === "1234") {
            // SAVE LOGIN STATE
            localStorage.setItem("fleet_admin_logged_in", "true");
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('admin-content').classList.remove('hidden');
            window.loadData();
        } else { alert("Wrong Password"); }
    };

    window.loadData = () => {
        const id = document.getElementById('taxi-selector').value;
        document.getElementById('current-taxi-label').innerText = "Editing: " + id.toUpperCase();
        
        onValue(ref(db, id + '/settings'), (snap) => {
            const d = snap.val() || {};
            document.getElementById('title').value = d.title || "";
            document.getElementById('dName').value = d.driverName || "";
            document.getElementById('tNo').value = d.taxiNo || "";
            document.getElementById('tModel').value = d.taxiModel || "";
            document.getElementById('phone').value = d.phone || "";
            document.getElementById('dImg').value = d.driverImg || "";
            document.getElementById('driver-img-prev').src = d.driverImg || "https://via.placeholder.com/150";
        }, { onlyOnce: true });

        const pkgRef = query(ref(db, id + '/packages'), orderByChild('sortOrder'));
        onValue(pkgRef, (snap) => {
            const list = document.getElementById('pkg-list');
            list.innerHTML = `<h3 class="text-xs font-bold text-gray-400 uppercase text-center">Manage Your Tours:</h3>`;
            let pkgs = [];
            snap.forEach(c => { pkgs.push({key: c.key, ...c.val()}); });

            pkgs.forEach((p, index) => {
                const safeData = btoa(encodeURIComponent(JSON.stringify(p)));
                list.innerHTML += `
                <div class="bg-white p-3 border rounded-lg shadow-sm border-l-4 border-blue-500 mb-2">
                    <div class="flex justify-between items-center">
                        <span class="font-black text-blue-900 uppercase text-[11px] truncate w-1/2">${p.title}</span>
                        <div class="flex gap-1">
                            ${index > 0 ? `<button onclick="movePkg('${p.key}', ${index})" class="bg-blue-600 text-white text-[10px] px-2 py-2 rounded">â†‘ UP</button>` : ''}
                            <button onclick="editPkg('${p.key}', '${safeData}')" class="bg-orange-500 text-white text-[10px] px-2 py-2 rounded">EDIT</button>
                            <button onclick="delPkg('${p.key}')" class="bg-red-500 text-white text-[10px] px-2 py-2 rounded">DEL</button>
                        </div>
                    </div>
                </div>`;
            });
        });
    };

    window.movePkg = async (key, index) => {
        const id = document.getElementById('taxi-selector').value;
        const dbRef = ref(db, id + '/packages');
        const snapshot = await get(query(dbRef, orderByChild('sortOrder')));
        
        if (snapshot.exists()) {
            let pkgs = [];
            snapshot.forEach(c => { pkgs.push({key: c.key, data: c.val()}); });
            
            const currentPkg = pkgs[index];
            const abovePkg = pkgs[index - 1];

            const updates = {};
            updates[`/${currentPkg.key}/sortOrder`] = index - 1;
            updates[`/${abovePkg.key}/sortOrder`] = index;

            await update(dbRef, updates);
            location.reload(); 
        }
    };

    window.addPkg = async () => {
        const id = document.getElementById('taxi-selector').value;
        const pkgRef = ref(db, id + '/packages');
        const snap = await get(pkgRef);
        const nextOrder = snap.exists() ? Object.keys(snap.val()).length : 0;

        push(pkgRef, {
            title: document.getElementById('pTitle').value,
            desc: document.getElementById('pDesc').value,
            img: document.getElementById('pImg').value || "https://via.placeholder.com/400x200",
            sortOrder: nextOrder
        }).then(() => { alert("Added!"); cancelEdit(); });
    };

    window.saveSet = () => {
        const id = document.getElementById('taxi-selector').value;
        update(ref(db, id + '/settings'), {
            title: document.getElementById('title').value,
            driverName: document.getElementById('dName').value,
            taxiNo: document.getElementById('tNo').value,
            taxiModel: document.getElementById('tModel').value,
            phone: document.getElementById('phone').value,
            driverImg: document.getElementById('dImg').value
        }).then(() => alert("Saved!"));
    };

    window.editPkg = (key, dataB64) => {
        const data = JSON.parse(decodeURIComponent(atob(dataB64)));
        document.getElementById('edit-pkg-id').value = key;
        document.getElementById('pTitle').value = data.title;
        document.getElementById('pImg').value = data.img;
        document.getElementById('pDesc').value = data.desc;
        document.getElementById('pkg-form-title').innerText = "Editing Mode";
        document.getElementById('btn-add').classList.add('hidden');
        document.getElementById('btn-update').classList.remove('hidden');
        document.getElementById('btn-cancel').classList.remove('hidden');
        window.scrollTo({top: 0, behavior: 'smooth'});
    };

    window.updatePkg = () => {
        const id = document.getElementById('taxi-selector').value;
        const key = document.getElementById('edit-pkg-id').value;
        update(ref(db, id + '/packages/' + key), {
            title: document.getElementById('pTitle').value,
            desc: document.getElementById('pDesc').value,
            img: document.getElementById('pImg').value
        }).then(() => { alert("Updated!"); cancelEdit(); });
    };

    window.cancelEdit = () => {
        document.getElementById('edit-pkg-id').value = "";
        document.getElementById('pTitle').value = "";
        document.getElementById('pImg').value = "";
        document.getElementById('pDesc').value = "";
        document.getElementById('pkg-form-title').innerText = "Add New Tour Package";
        document.getElementById('btn-add').classList.remove('hidden');
        document.getElementById('btn-update').classList.add('hidden');
        document.getElementById('btn-cancel').classList.add('hidden');
    };

    window.delPkg = (key) => {
        const id = document.getElementById('taxi-selector').value;
        if(confirm("Delete this?")) remove(ref(db, id + '/packages/' + key));
    };
</script>
